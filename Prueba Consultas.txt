-- 1. Mostrar las colecciones de usuarios con el título del media y su opinión
SELECT 
    u.nombre,
    m.titulo,
    m.tipo_media,
    o.numero_estrellas,
    o.comentario
FROM Usuario u
JOIN Coleccion c ON u.usuario_id = c.usuario_id
JOIN Media m ON c.media_id = m.media_id
JOIN Opinion o ON c.opinion_id = o.opinion_id
ORDER BY u.nombre;

-- 2. Mostrar todos los videojuegos con su plataforma y género
SELECT 
    m.titulo,
    p.nombre_plataforma,
    g.nombre_genero,
    m.fecha_publicacion
FROM Videojuego v
JOIN Media m ON v.media_id = m.media_id
JOIN Plataforma p ON v.plataforma_id = p.plataforma_id
JOIN Genero g ON v.genero_id = g.genero_id;

-- 3. Calcular el promedio de calificaciones por tipo de media
SELECT 
    m.tipo_media,
    ROUND(AVG(o.numero_estrellas), 2) as promedio_estrellas,
    COUNT(*) as total_opiniones
FROM Media m
JOIN Opinion o ON m.media_id = o.media_id
GROUP BY m.tipo_media;

-- 4. Listar todas las series (TV y Anime) con su número de episodios y temporadas
SELECT 
    m.titulo,
    m.tipo_media,
    CASE 
        WHEN t.tv_id IS NOT NULL THEN t.total_episodios
        WHEN a.anime_id IS NOT NULL THEN a.total_episodios
    END as total_episodios,
    CASE 
        WHEN t.tv_id IS NOT NULL THEN t.total_temporadas
        WHEN a.anime_id IS NOT NULL THEN a.total_temporadas
    END as total_temporadas
FROM Media m
LEFT JOIN TV t ON m.media_id = t.media_id
LEFT JOIN Anime a ON m.media_id = a.media_id
WHERE m.tipo_media IN ('TV', 'Anime');

-- 5. Encontrar los usuarios más activos (con más items en su colección y opiniones)
SELECT 
    u.nombre,
    COUNT(DISTINCT c.coleccion_id) as items_en_coleccion,
    COUNT(DISTINCT o.opinion_id) as total_opiniones
FROM Usuario u
LEFT JOIN Coleccion c ON u.usuario_id = c.usuario_id
LEFT JOIN Opinion o ON u.usuario_id = o.usuario_id
GROUP BY u.usuario_id, u.nombre
ORDER BY items_en_coleccion DESC, total_opiniones DESC;